const { fraction } = require('mathjs');

const toArray = (input) => {
  if (typeof input === 'object')
    return Array.from(input);
  else
    return [].concat(input);
};

const toRational = (input) => {
  return toArray(input).map(Number).map((dec) => {
    const fra = fraction(Number(dec));
    return [fra.n, fra.d];
  });
};

const toAscii = (input) => {
  if (typeof input === 'string')
    return input;
  return new TextDecoder('utf-8').decode(new Uint8Array(toArray(input)));
};

const toByte = (input) => {
  return Buffer.from(toArray(input)).toString();
};

const formatTypes = (tag, raw) => {
  const output = {};
  for (const [key, value] of Object.entries(raw))
    output[key] = types[tag][key](value);
  return output;
};

const types = {
  '0th': {
    '11': toAscii,
    '254': toArray,
    '255': toArray,
    '256': toArray,
    '257': toArray,
    '258': toArray,
    '259': toArray,
    '262': toArray,
    '263': toArray,
    '264': toArray,
    '265': toArray,
    '266': toArray,
    '269': toAscii,
    '270': toAscii,
    '271': toAscii,
    '272': toAscii,
    '273': toArray,
    '274': toArray,
    '277': toArray,
    '278': toArray,
    '279': toArray,
    '282': toRational,
    '283': toRational,
    '284': toArray,
    '290': toArray,
    '291': toArray,
    '292': toArray,
    '293': toArray,
    '296': toArray,
    '301': toArray,
    '305': toAscii,
    '306': toAscii,
    '315': toAscii,
    '316': toAscii,
    '317': toArray,
    '318': toRational,
    '319': toRational,
    '320': toArray,
    '321': toArray,
    '322': toArray,
    '323': toArray,
    '324': toArray,
    '325': toArray,
    '330': toArray,
    '332': toArray,
    '333': toAscii,
    '334': toArray,
    '336': toByte,
    '337': toAscii,
    '338': toArray,
    '339': toArray,
    '340': toArray,
    '341': toArray,
    '342': toArray,
    '343': toByte,
    '344': toArray,
    '345': toArray,
    '346': toArray,
    '347': toAscii,
    '351': toArray,
    '512': toArray,
    '513': toArray,
    '514': toArray,
    '515': toArray,
    '517': toArray,
    '518': toArray,
    '519': toArray,
    '520': toArray,
    '521': toArray,
    '529': toRational,
    '530': toArray,
    '531': toArray,
    '532': toRational,
    '700': toByte,
    '18246': toArray,
    '18249': toArray,
    '32781': toAscii,
    '33421': toArray,
    '33422': toByte,
    '33423': toRational,
    '33432': toAscii,
    '33434': toRational,
    '34377': toByte,
    '34665': toArray,
    '34675': toAscii,
    '34853': toArray,
    '34857': toArray,
    '34858': toArray,
    '34859': toArray,
    '37387': toRational,
    '37388': toAscii,
    '37389': toAscii,
    '37390': toRational,
    '37391': toRational,
    '37392': toArray,
    '37393': toArray,
    '37394': toAscii,
    '37395': toAscii,
    '37397': toRational,
    '37398': toByte,
    '37399': toArray,
    '40091': toByte,
    '40092': toByte,
    '40093': toByte,
    '40094': toByte,
    '40095': toByte,
    '50341': toAscii,
    '50706': toByte,
    '50707': toByte,
    '50708': toAscii,
    '50709': toByte,
    '50710': toByte,
    '50711': toArray,
    '50712': toArray,
    '50713': toArray,
    '50714': toRational,
    '50715': toRational,
    '50716': toRational,
    '50717': toArray,
    '50718': toRational,
    '50719': toArray,
    '50720': toArray,
    '50721': toRational,
    '50722': toRational,
    '50723': toRational,
    '50724': toRational,
    '50725': toRational,
    '50726': toRational,
    '50727': toRational,
    '50728': toArray,
    '50729': toRational,
    '50730': toRational,
    '50731': toRational,
    '50732': toRational,
    '50733': toArray,
    '50734': toRational,
    '50735': toAscii,
    '50736': toRational,
    '50737': toRational,
    '50738': toRational,
    '50739': toRational,
    '50740': toByte,
    '50741': toArray,
    '50778': toArray,
    '50779': toArray,
    '50780': toRational,
    '50781': toByte,
    '50827': toByte,
    '50828': toAscii,
    '50829': toArray,
    '50830': toArray,
    '50831': toAscii,
    '50832': toRational,
    '50833': toAscii,
    '50834': toRational,
    '50879': toArray,
    '50931': toByte,
    '50932': toByte,
    '50934': toByte,
    '50935': toRational,
    '50936': toByte,
    '50937': toArray,
    '50941': toArray,
    '50942': toByte,
    '50964': toRational,
    '50965': toRational,
    '50966': toByte,
    '50967': toByte,
    '50968': toByte,
    '50969': toByte,
    '50970': toArray,
    '50971': toAscii,
    '50972': toAscii,
    '50973': toAscii,
    '50974': toArray,
    '50975': toArray,
    '50981': toArray,
    '51008': toAscii,
    '51009': toAscii,
    '51022': toAscii,
  },
  'Exif': {
    '33434': toRational,
    '33437': toRational,
    '34850': toArray,
    '34852': toAscii,
    '34855': toArray,
    '34856': toAscii,
    '34864': toArray,
    '34865': toArray,
    '34866': toArray,
    '34867': toArray,
    '34868': toArray,
    '34869': toArray,
    '36864': toAscii,
    '36867': toAscii,
    '36868': toAscii,
    '37121': toAscii,
    '37122': toRational,
    '37377': toRational,
    '37378': toRational,
    '37379': toRational,
    '37380': toRational,
    '37381': toRational,
    '37382': toRational,
    '37383': toArray,
    '37384': toArray,
    '37385': toArray,
    '37386': toRational,
    '37396': toArray,
    '37500': toAscii,
    '37510': toAscii,
    '37520': toAscii,
    '37521': toAscii,
    '37522': toAscii,
    '40960': toAscii,
    '40961': toArray,
    '40962': toArray,
    '40963': toArray,
    '40964': toAscii,
    '40965': toArray,
    '41483': toRational,
    '41484': toAscii,
    '41486': toRational,
    '41487': toRational,
    '41488': toArray,
    '41492': toArray,
    '41493': toRational,
    '41495': toArray,
    '41728': toAscii,
    '41729': toAscii,
    '41730': toAscii,
    '41985': toArray,
    '41986': toArray,
    '41987': toArray,
    '41988': toRational,
    '41989': toArray,
    '41990': toArray,
    '41991': toArray,
    '41992': toArray,
    '41993': toArray,
    '41994': toArray,
    '41995': toAscii,
    '41996': toArray,
    '42016': toAscii,
    '42032': toAscii,
    '42033': toAscii,
    '42034': toRational,
    '42035': toAscii,
    '42036': toAscii,
    '42037': toAscii,
    '42240': toRational,
  },
  'GPS': {
    '0': toByte,
    '1': toAscii,
    '2': toRational,
    '3': toAscii,
    '4': toRational,
    '5': toArray,
    '6': toRational,
    '7': toRational,
    '8': toAscii,
    '9': toAscii,
    '10': toAscii,
    '11': toRational,
    '12': toAscii,
    '13': toRational,
    '14': toAscii,
    '15': toRational,
    '16': toAscii,
    '17': toRational,
    '18': toAscii,
    '19': toAscii,
    '20': toRational,
    '21': toAscii,
    '22': toRational,
    '23': toAscii,
    '24': toRational,
    '25': toAscii,
    '26': toRational,
    '27': toAscii,
    '28': toAscii,
    '29': toAscii,
    '30': toArray,
    '31': toRational,
  }
};

module.exports = {
  formatTypes,
};
